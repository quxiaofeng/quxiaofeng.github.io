{"title":"A Little ctypes Example","slug":"ctypes-example","date":"2014-02-28T11:27:07.000Z","updated":"2018-04-21T08:18:25.482Z","comments":true,"path":"api/articles/ctypes-example.json","photos":["http://i.imgur.com/EsDsYsI.png"],"link":"","excerpt":"A simple ctypes example interfacing a windows dll to python.","covers":["http://i.imgur.com/EsDsYsI.png","http://i.imgur.com/O6Gc5oz.png","http://i.imgur.com/3I3AWXk.png","http://i.imgur.com/d0Ku9wE.png","http://i.imgur.com/WluRzwI.png"],"content":"<p>A simple ctypes example interfacing a windows dll to python.</p>\n<a id=\"more\"></a>\n<h2 id=\"The-ctypes-package\"><a href=\"#The-ctypes-package\" class=\"headerlink\" title=\"The ctypes package\"></a>The ctypes package</h2><ul>\n<li><a href=\"http://starship.python.net/crew/theller/ctypes/\" target=\"_blank\" rel=\"noopener\">Homepage</a></li>\n</ul>\n<p>“ctypes” is an advanced ffi (Foreign Function Interface) , and it has been included in the standard distribution of python since 2.5.</p>\n<p>“ctypes allows to call functions in dlls/shared libraries and has extensive facilities to create, access and manipulate simple and complicated C data types in Python - in other words: wrap libraries in pure Python. It is even possible to implement C callback functions in pure Python.”</p>\n<p>In essence, ctypes find the name of C functions in the dll file and execute the function code directly. It provides a very easy and effective way to call C functions from python. A simple example is shown below.</p>\n<h2 id=\"A-Simple-Example\"><a href=\"#A-Simple-Example\" class=\"headerlink\" title=\"A Simple Example\"></a>A Simple Example</h2><pre><code>from ctypes import *\nuser32 = windll.LoadLibrary(&apos;user32.dll&apos;) # load dll\nuser32.MessageBoxA(0, &apos;Ctypes is cool!&apos;, &apos;Ctypes&apos;, 0)\n# call message box function\n</code></pre><p>First, the ctypes package is imported to current file. Then the user32.dll is loaded as variant user32. (user32.dll is a basic windows dynamic library. It is pre-installed in every windows operating system.) After the loading of user32 library, we can call MessageBoxA function, which is in the user32 library as an ordinary python method. The MessageBoxA pops up a message box over the desktop. The parameters defined the text and title of this message box as shown below.</p>\n<figure><br>  <img src=\"http://i.imgur.com/EsDsYsI.png\"><br>  <figcaption><br>  Message box called by python<br>  </figcaption><br></figure>\n\n<p>In this calling process, no lower level code is need. DLL functions can be called solely by python.</p>\n<p>However, a critical problem is that the ctypes package only supports C function or C++ function without Class feature. <strong>It does not support C++ Class.</strong></p>\n<h2 id=\"A-Failed-C-Class-Example\"><a href=\"#A-Failed-C-Class-Example\" class=\"headerlink\" title=\"A Failed C++ Class Example\"></a>A Failed C++ Class Example</h2><p>The C function name saving in the dll file is identical with one in the source file. Nevertheless, the C++ function is not. For example, a function name is “enum ePiCommType CPDIdev::DiscoverCnx(int)” in source file. In the DLL file, the function name is “?DiscoverCnx@CPDIdev@@UAE?AW4ePiCommType@@H@Z” as shown in the figure below. The ctypes package can resolve latter one as the former one. That is how it can call C functions.</p>\n<figure><br>  <img src=\"http://i.imgur.com/O6Gc5oz.png\"><br>  <figcaption><br>  The C++ function name in the DLL file under the inspection tool<br>  </figcaption><br></figure>\n\n<p>The names of functions can be inspected by “<a href=\"http://www.dependencywalker.com/\" target=\"_blank\" rel=\"noopener\">Dependency Walker</a>“.</p>\n<figure><br>  <img src=\"http://i.imgur.com/3I3AWXk.png\"><br>  <figcaption><br>  Dependency Walker Homepage<br>  </figcaption><br></figure>\n\n<p>In addition, the python can find the function with the help of the ctypes package in a similar way as shown below.</p>\n<figure><br>  <img src=\"http://i.imgur.com/d0Ku9wE.png\"><br>  <figcaption><br>  Python find a function pointer in the DLL file<br>  </figcaption><br></figure>\n\n<p>The address of the function “enum ePiCommType CPDIdev::DiscoverCnx(int)” is found in 0x01D65828. However, it raised an exception when it is being called as shown below.</p>\n<figure><br>  <img src=\"http://i.imgur.com/WluRzwI.png\"><br>  <figcaption><br>  Exception raised when called by python<br>  </figcaption><br></figure>\n\n<p>This exception is raised because the ctypes does not support C++ class. In a C++ class, the member function rewrites member variants, which are out of the range of the function. That is why the system raised an access violation exception.</p>\n","categories":[{"name":"coding","slug":"coding","count":26,"path":"api/categories/coding.json"}],"tags":[{"name":"python","slug":"python","count":7,"path":"api/tags/python.json"},{"name":"c++","slug":"c","count":4,"path":"api/tags/c.json"},{"name":"note","slug":"note","count":7,"path":"api/tags/note.json"},{"name":"c","slug":"c","count":2,"path":"api/tags/c.json"}]}