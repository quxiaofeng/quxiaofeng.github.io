<!DOCTYPE html><html lang="zh-CN"><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><meta name="author" content="Xiaofeng QU"><title>A Little ctypes Example · Xiaofeng QU</title><meta name="description" content="A simple ctypes example interfacing a windows dll to python.

The ctypes package
Homepage

“ctypes” is an advanced ffi (Foreign Function Interface) , "><meta name="keywords" content=""><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="renderer" content="webkit"><link rel="short icon" href="/images/favicon.png" type="image/x-icon"><link rel="stylesheet" href="/css/bootstrap.min.css"><link rel="stylesheet" href="/css/font-awesome.min.css"><link rel="stylesheet" href="/css/style.css"><link rel="alternate" type="application/atom+xml" title="ATOM 1.0" href="/atom.xml"></head><body><div id="stage" class="container"><div class="row"><div id="side-bar" class="col-sm-3 col-xs-12 side-container invisible"><div class="vertical-text site-title"><h3 tabindex="-1" class="site-title-small"><a href="/" class="a-title">博客</a></h3><h1 tabindex="-1" class="site-title-large"><a href="/" class="a-title">曲晓峰</a></h1><!--h6(onclick="triggerSiteNav()") Trigger--></div><br class="visible-lg visible-md visible-sm"><div id="site-nav" class="site-title-links"><ul><li><a href="/">Home</a></li><li><a href="/archives">Archive</a></li><li><a href="/categories">Categories</a></li><li><a href="/tags">Tags</a></li><li><a href="//about/index.html">About</a></li><li><a href="//links/index.html">Links</a></li><li><a href="//3/1415926/index.html">Pi page</a></li><li><a href="//research/index.html">Research</a></li><li><a href="/talks/python-function.html"></a></li><li><a href="/talks/python-interface.html"></a></li><li class="soc"><a href="https://github.com/quxiaofeng" target="_blank" rel="noopener noreferrer"><i class="fa fa-github">&nbsp;</i></a><a href="https://twitter.com/quxiaofeng" target="_blank" rel="noopener noreferrer"><i class="fa fa-twitter">&nbsp;</i></a><a href="https://www.instagram.com/quxiaofeng" target="_blank" rel="noopener noreferrer"><i class="fa fa-instagram">&nbsp;</i></a><a href="http://www.quxiaofeng.me/atom.xml" target="_blank" rel="noopener noreferrer"><i class="fa fa-rss">&nbsp;</i></a></li></ul><div class="visible-lg visible-md visible-sm site-nav-footer"><br class="site-nav-footer-br"><footer><p>&copy;&nbsp;2018&nbsp;<a target="_blank" href="http://www.quxiaofeng.me" rel="noopener noreferrer">Xiaofeng QU</a></p><p>Theme&nbsp;<a target="_blank" href="https://github.com/SumiMakito/hexo-theme-typography" rel="noopener noreferrer">Typography</a>&nbsp;by&nbsp;<a target="_blank" href="https://www.keep.moe" rel="noopener noreferrer">Makito</a></p><p>Proudly published with&nbsp;<a target="_blank" href="https://hexo.io" rel="noopener noreferrer">Hexo</a></p></footer></div></div></div><div id="main-container" class="col-sm-9 col-xs-12 main-container invisible"><div class="autopagerize_page_element"><div class="content"><div class="post-page"><div class="post-container"><p class="post-title"><a>A Little ctypes Example</a></p><p class="post-meta"><span class="date meta-item">Posted at&nbsp;2014-02-28</span><span class="meta-item"><i class="fa fa-comment-o"></i><span>&nbsp;</span><a href="/2014/02/28/ctypes-example/#comments">Comments</a></span><span class="meta-item"><i class="fa fa-folder"></i><span>&nbsp;</span><a href="/categories/coding/" title="coding" class="a-tag">coding</a><span>&nbsp;</span></span><span class="meta-item"><i class="fa fa-tag"></i><span>&nbsp;</span><a href="/tags/python/" title="python" class="a-tag">python</a><span>&nbsp;</span><a href="/tags/c/" title="c++" class="a-tag">c++</a><span>&nbsp;</span><a href="/tags/note/" title="note" class="a-tag">note</a><span>&nbsp;</span><a href="/tags/c/" title="c" class="a-tag">c</a><span>&nbsp;</span></span></p><p class="post-abstract"><p>A simple ctypes example interfacing a windows dll to python.</p>
<a id="more"></a>
<h2 id="The-ctypes-package"><a href="#The-ctypes-package" class="headerlink" title="The ctypes package"></a>The ctypes package</h2><ul>
<li><a href="http://starship.python.net/crew/theller/ctypes/" target="_blank" rel="noopener">Homepage</a></li>
</ul>
<p>“ctypes” is an advanced ffi (Foreign Function Interface) , and it has been included in the standard distribution of python since 2.5.</p>
<p>“ctypes allows to call functions in dlls/shared libraries and has extensive facilities to create, access and manipulate simple and complicated C data types in Python - in other words: wrap libraries in pure Python. It is even possible to implement C callback functions in pure Python.”</p>
<p>In essence, ctypes find the name of C functions in the dll file and execute the function code directly. It provides a very easy and effective way to call C functions from python. A simple example is shown below.</p>
<h2 id="A-Simple-Example"><a href="#A-Simple-Example" class="headerlink" title="A Simple Example"></a>A Simple Example</h2><pre><code>from ctypes import *
user32 = windll.LoadLibrary(&apos;user32.dll&apos;) # load dll
user32.MessageBoxA(0, &apos;Ctypes is cool!&apos;, &apos;Ctypes&apos;, 0)
# call message box function
</code></pre><p>First, the ctypes package is imported to current file. Then the user32.dll is loaded as variant user32. (user32.dll is a basic windows dynamic library. It is pre-installed in every windows operating system.) After the loading of user32 library, we can call MessageBoxA function, which is in the user32 library as an ordinary python method. The MessageBoxA pops up a message box over the desktop. The parameters defined the text and title of this message box as shown below.</p>
<figure><br>  <img src="http://i.imgur.com/EsDsYsI.png"><br>  <figcaption><br>  Message box called by python<br>  </figcaption><br></figure>

<p>In this calling process, no lower level code is need. DLL functions can be called solely by python.</p>
<p>However, a critical problem is that the ctypes package only supports C function or C++ function without Class feature. <strong>It does not support C++ Class.</strong></p>
<h2 id="A-Failed-C-Class-Example"><a href="#A-Failed-C-Class-Example" class="headerlink" title="A Failed C++ Class Example"></a>A Failed C++ Class Example</h2><p>The C function name saving in the dll file is identical with one in the source file. Nevertheless, the C++ function is not. For example, a function name is “enum ePiCommType CPDIdev::DiscoverCnx(int)” in source file. In the DLL file, the function name is “?DiscoverCnx@CPDIdev@@UAE?AW4ePiCommType@@H@Z” as shown in the figure below. The ctypes package can resolve latter one as the former one. That is how it can call C functions.</p>
<figure><br>  <img src="http://i.imgur.com/O6Gc5oz.png"><br>  <figcaption><br>  The C++ function name in the DLL file under the inspection tool<br>  </figcaption><br></figure>

<p>The names of functions can be inspected by “<a href="http://www.dependencywalker.com/" target="_blank" rel="noopener">Dependency Walker</a>“.</p>
<figure><br>  <img src="http://i.imgur.com/3I3AWXk.png"><br>  <figcaption><br>  Dependency Walker Homepage<br>  </figcaption><br></figure>

<p>In addition, the python can find the function with the help of the ctypes package in a similar way as shown below.</p>
<figure><br>  <img src="http://i.imgur.com/d0Ku9wE.png"><br>  <figcaption><br>  Python find a function pointer in the DLL file<br>  </figcaption><br></figure>

<p>The address of the function “enum ePiCommType CPDIdev::DiscoverCnx(int)” is found in 0x01D65828. However, it raised an exception when it is being called as shown below.</p>
<figure><br>  <img src="http://i.imgur.com/WluRzwI.png"><br>  <figcaption><br>  Exception raised when called by python<br>  </figcaption><br></figure>

<p>This exception is raised because the ctypes does not support C++ class. In a C++ class, the member function rewrites member variants, which are out of the range of the function. That is why the system raised an access violation exception.</p>
</p></div><div class="share"><span>Share</span>&nbsp;<span class="soc"><a href="javascript:(function(){EN_CLIP_HOST='http://www.evernote.com';try{var%20x=document.createElement('SCRIPT');x.type='text/javascript';x.src=EN_CLIP_HOST+'/public/bookmarkClipper.js?'+(new%20Date().getTime()/100000);document.getElementsByTagName('head')[0].appendChild(x);}catch(e){location.href=EN_CLIP_HOST+'/clip.action?url='+encodeURIComponent(location.href)+'&amp;title='+encodeURIComponent(document.title);}})();" ref="nofollow" target="_blank" class="fa fa-bookmark"></a></span><span class="soc"><a href="javascript:void((function(s,d,e){try{}catch(e){}var f='http://service.weibo.com/share/share.php?',u=d.location.href,p=['url=',e(u),'&amp;title=',e(d.title),'&amp;appkey=2924220432'].join('');function a(){if(!window.open([f,p].join(''),'mb',['toolbar=0,status=0,resizable=1,width=620,height=450,left=',(s.width-620)/2,',top=',(s.height-450)/2].join('')))u.href=[f,p].join('');};if(/Firefox/.test(navigator.userAgent)){setTimeout(a,0)}else{a()}})(screen,document,encodeURIComponent));" class="fa fa-weibo"></a></span><span class="soc"><a href="http://twitter.com/home?status=http://www.quxiaofeng.me/2014/02/28/ctypes-example/%20Xiaofeng QU%20A Little ctypes Example" class="fa fa-twitter"></a></span></div><div class="pagination"><p class="clearfix"><span class="pre pagbuttons"><a role="navigation" href="/2014/03/01/swig-example/" title="A SWIG Example"><i class="fa fa-angle-double-left"></i>&nbsp;Previous post: A SWIG Example</a></span><span>&nbsp;</span><span class="next pagbuttons"><a role="navigation" href="/2014/02/27/canopy-welcome-issue/" title="Enthought Canopy 1.3.0 Welcome Issue">Next post: Enthought Canopy 1.3.0 Welcome Issue&nbsp;<i class="fa fa-angle-double-right"></i></a></span></p></div><a id="comments"></a><div id="disqus_thread"></div><script>var disqus_shortname = 'quxiaofenggithub# [short_name] on disqus.com';
var disqus_identifier = '2014/02/28/ctypes-example/';
var disqus_title = 'A Little ctypes Example';
var disqus_url = 'http://www.quxiaofeng.me/2014/02/28/ctypes-example/';
(function () {
    var dsq = document.createElement('script');
    dsq.type = 'text/javascript';
    dsq.async = true;
    dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
})();</script><script id="dsq-count-scr" src="//quxiaofenggithub# [short_name] on disqus.com.disqus.com/count.js" async></script></div></div></div><div class="visible-xs site-bottom-footer"><footer><p>&copy;&nbsp;2018&nbsp;<a target="_blank" href="http://www.quxiaofeng.me" rel="noopener noreferrer">Xiaofeng QU</a></p><p>Theme&nbsp;<a target="_blank" href="https://github.com/SumiMakito/hexo-theme-typography" rel="noopener noreferrer">Typography</a>&nbsp;by&nbsp;<a target="_blank" href="https://www.keep.moe" rel="noopener noreferrer">Makito</a></p><p>Proudly published with&nbsp;<a target="_blank" href="https://hexo.io" rel="noopener noreferrer">Hexo</a></p></footer></div></div></div></div><script src="/js/jquery-3.1.0.min.js"></script><script src="/js/bootstrap.min.js"></script><script src="/js/jquery-migrate-1.2.1.min.js"></script><script src="/js/jquery.appear.js"></script><script src="/js/google-analytics.js"></script><script src="/js/typography.js"></script></body></html>