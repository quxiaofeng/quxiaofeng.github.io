<!DOCTYPE html>
<html lang=en>
<head>
    <!-- so meta -->
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="HandheldFriendly" content="True">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
    <meta name="description" content="A simple ctypes example interfacing a windows dll to python.">
<meta name="keywords" content="python,c++,note,c">
<meta property="og:type" content="article">
<meta property="og:title" content="A Little ctypes Example">
<meta property="og:url" content="http://www.quxiaofeng.me/2014/02/28/ctypes-example/index.html">
<meta property="og:site_name" content="Xiaofeng QU">
<meta property="og:description" content="A simple ctypes example interfacing a windows dll to python.">
<meta property="og:locale" content="en">
<meta property="og:image" content="http://i.imgur.com/EsDsYsI.png">
<meta property="og:updated_time" content="2018-04-19T06:41:51.703Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="A Little ctypes Example">
<meta name="twitter:description" content="A simple ctypes example interfacing a windows dll to python.">
<meta name="twitter:image" content="http://i.imgur.com/EsDsYsI.png">
    
    
        
          
              <link rel="shortcut icon" href="/images/avatar.png">
          
        
        
          
            <link rel="icon" type="image/png" href="/images/avatar.png" sizes="192x192">
          
        
        
          
            <link rel="apple-touch-icon" sizes="180x180" href="/images/avatar.png">
          
        
    
    <!-- title -->
    <title>A Little ctypes Example</title>
    <!-- styles -->
    <link rel="stylesheet" href="/css/style.css">
    <!-- rss -->
    
    
</head>

<body class="max-width mx-auto px3">
    
      <div id="header-post">
  <a id="menu-icon" href="#"><i class="fas fa-bars fa-lg"></i></a>
  <a id="menu-icon-tablet" href="#"><i class="fas fa-bars fa-lg"></i></a>
  <a id="top-icon-tablet" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');" style="display:none;"><i class="fas fa-chevron-up fa-lg"></i></a>
  <span id="menu">
    <span id="nav">
      <ul>
         
          <li><a href="/">Home</a></li>
         
          <li><a href="/archives/">Blog</a></li>
         
          <li><a href="/research/">Research</a></li>
         
          <li><a href="/links/">Links</a></li>
         
          <li><a href="/about/">About</a></li>
        
      </ul>
    </span>
    <br/>
    <span id="actions">
      <ul>
        
        <li><a class="icon" href="/2014/03/01/swig-example/"><i class="fas fa-chevron-left" aria-hidden="true" onmouseover="$('#i-prev').toggle();" onmouseout="$('#i-prev').toggle();"></i></a></li>
        
        
        <li><a class="icon" href="/2014/02/27/canopy-welcome-issue/"><i class="fas fa-chevron-right" aria-hidden="true" onmouseover="$('#i-next').toggle();" onmouseout="$('#i-next').toggle();"></i></a></li>
        
        <li><a class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fas fa-chevron-up" aria-hidden="true" onmouseover="$('#i-top').toggle();" onmouseout="$('#i-top').toggle();"></i></a></li>
        <li><a class="icon" href="#"><i class="fas fa-share-alt" aria-hidden="true" onmouseover="$('#i-share').toggle();" onmouseout="$('#i-share').toggle();" onclick="$('#share').toggle();return false;"></i></a></li>
      </ul>
      <span id="i-prev" class="info" style="display:none;">Previous post</span>
      <span id="i-next" class="info" style="display:none;">Next post</span>
      <span id="i-top" class="info" style="display:none;">Back to top</span>
      <span id="i-share" class="info" style="display:none;">Share post</span>
    </span>
    <br/>
    <div id="share" style="display: none">
      <ul>
  <li><a class="icon" href="http://www.facebook.com/sharer.php?u=http://www.quxiaofeng.me/2014/02/28/ctypes-example/"><i class="fab fa-facebook " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://twitter.com/share?url=http://www.quxiaofeng.me/2014/02/28/ctypes-example/&text=A Little ctypes Example"><i class="fab fa-twitter " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.linkedin.com/shareArticle?url=http://www.quxiaofeng.me/2014/02/28/ctypes-example/&title=A Little ctypes Example"><i class="fab fa-linkedin " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://pinterest.com/pin/create/bookmarklet/?url=http://www.quxiaofeng.me/2014/02/28/ctypes-example/&is_video=false&description=A Little ctypes Example"><i class="fab fa-pinterest " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=A Little ctypes Example&body=Check out this article: http://www.quxiaofeng.me/2014/02/28/ctypes-example/"><i class="fas fa-envelope " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://getpocket.com/save?url=http://www.quxiaofeng.me/2014/02/28/ctypes-example/&title=A Little ctypes Example"><i class="fab fa-get-pocket " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://reddit.com/submit?url=http://www.quxiaofeng.me/2014/02/28/ctypes-example/&title=A Little ctypes Example"><i class="fab fa-reddit " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.stumbleupon.com/submit?url=http://www.quxiaofeng.me/2014/02/28/ctypes-example/&title=A Little ctypes Example"><i class="fab fa-stumbleupon " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://digg.com/submit?url=http://www.quxiaofeng.me/2014/02/28/ctypes-example/&title=A Little ctypes Example"><i class="fab fa-digg " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.tumblr.com/share/link?url=http://www.quxiaofeng.me/2014/02/28/ctypes-example/&name=A Little ctypes Example&description=&lt;p&gt;A simple ctypes example interfacing a windows dll to python.&lt;/p&gt;"><i class="fab fa-tumblr " aria-hidden="true"></i></a></li>
</ul>

    </div>
    <div id="toc">
      <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#The-ctypes-package"><span class="toc-number">1.</span> <span class="toc-text">The ctypes package</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#A-Simple-Example"><span class="toc-number">2.</span> <span class="toc-text">A Simple Example</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#A-Failed-C-Class-Example"><span class="toc-number">3.</span> <span class="toc-text">A Failed C++ Class Example</span></a></li></ol>
    </div>
  </span>
</div>

    
    <div class="content index my4">
        
        <article class="post" itemscope itemtype="http://schema.org/BlogPosting">
  <header>
    
    <h1 class="posttitle" itemprop="name headline">
        A Little ctypes Example
    </h1>



    <div class="meta">
      <span class="author" itemprop="author" itemscope itemtype="http://schema.org/Person">
        <span itemprop="name">Xiaofeng QU</span>
      </span>
      
    <div class="postdate">
        <time datetime="2014-02-28T11:27:07.000Z" itemprop="datePublished">February 28, 2014</time>
    </div>


      
    <div class="article-tag">
        <i class="fas fa-tag"></i>
        <a class="tag-link" href="/tags/c/">c</a>, <a class="tag-link" href="/tags/c/">c++</a>, <a class="tag-link" href="/tags/note/">note</a>, <a class="tag-link" href="/tags/python/">python</a>
    </div>


    </div>
  </header>
  
<div class="article-gallery">
    
    <a class="gallery-item" href="http://i.imgur.com/EsDsYsI.png" rel="gallery_cjg65sgyn002whm2iezfusnxm">
        <img src="http://i.imgur.com/EsDsYsI.png" itemprop="image" />
    </a>
    
</div>


  <div class="content" itemprop="articleBody">
    <p>A simple ctypes example interfacing a windows dll to python.</p>
<a id="more"></a>
<h2 id="The-ctypes-package"><a href="#The-ctypes-package" class="headerlink" title="The ctypes package"></a>The ctypes package</h2><ul>
<li><a href="http://starship.python.net/crew/theller/ctypes/" target="_blank" rel="noopener">Homepage</a></li>
</ul>
<p>“ctypes” is an advanced ffi (Foreign Function Interface) , and it has been included in the standard distribution of python since 2.5.</p>
<p>“ctypes allows to call functions in dlls/shared libraries and has extensive facilities to create, access and manipulate simple and complicated C data types in Python - in other words: wrap libraries in pure Python. It is even possible to implement C callback functions in pure Python.”</p>
<p>In essence, ctypes find the name of C functions in the dll file and execute the function code directly. It provides a very easy and effective way to call C functions from python. A simple example is shown below.</p>
<h2 id="A-Simple-Example"><a href="#A-Simple-Example" class="headerlink" title="A Simple Example"></a>A Simple Example</h2><pre><code>from ctypes import *
user32 = windll.LoadLibrary(&apos;user32.dll&apos;) # load dll
user32.MessageBoxA(0, &apos;Ctypes is cool!&apos;, &apos;Ctypes&apos;, 0)
# call message box function
</code></pre><p>First, the ctypes package is imported to current file. Then the user32.dll is loaded as variant user32. (user32.dll is a basic windows dynamic library. It is pre-installed in every windows operating system.) After the loading of user32 library, we can call MessageBoxA function, which is in the user32 library as an ordinary python method. The MessageBoxA pops up a message box over the desktop. The parameters defined the text and title of this message box as shown below.</p>
<figure><br>  <img src="http://i.imgur.com/EsDsYsI.png"><br>  <figcaption><br>  Message box called by python<br>  </figcaption><br></figure>

<p>In this calling process, no lower level code is need. DLL functions can be called solely by python.</p>
<p>However, a critical problem is that the ctypes package only supports C function or C++ function without Class feature. <strong>It does not support C++ Class.</strong></p>
<h2 id="A-Failed-C-Class-Example"><a href="#A-Failed-C-Class-Example" class="headerlink" title="A Failed C++ Class Example"></a>A Failed C++ Class Example</h2><p>The C function name saving in the dll file is identical with one in the source file. Nevertheless, the C++ function is not. For example, a function name is “enum ePiCommType CPDIdev::DiscoverCnx(int)” in source file. In the DLL file, the function name is “?DiscoverCnx@CPDIdev@@UAE?AW4ePiCommType@@H@Z” as shown in the figure below. The ctypes package can resolve latter one as the former one. That is how it can call C functions.</p>
<figure><br>  <img src="http://i.imgur.com/O6Gc5oz.png"><br>  <figcaption><br>  The C++ function name in the DLL file under the inspection tool<br>  </figcaption><br></figure>

<p>The names of functions can be inspected by “<a href="http://www.dependencywalker.com/" target="_blank" rel="noopener">Dependency Walker</a>“.</p>
<figure><br>  <img src="http://i.imgur.com/3I3AWXk.png"><br>  <figcaption><br>  Dependency Walker Homepage<br>  </figcaption><br></figure>

<p>In addition, the python can find the function with the help of the ctypes package in a similar way as shown below.</p>
<figure><br>  <img src="http://i.imgur.com/d0Ku9wE.png"><br>  <figcaption><br>  Python find a function pointer in the DLL file<br>  </figcaption><br></figure>

<p>The address of the function “enum ePiCommType CPDIdev::DiscoverCnx(int)” is found in 0x01D65828. However, it raised an exception when it is being called as shown below.</p>
<figure><br>  <img src="http://i.imgur.com/WluRzwI.png"><br>  <figcaption><br>  Exception raised when called by python<br>  </figcaption><br></figure>

<p>This exception is raised because the ctypes does not support C++ class. In a C++ class, the member function rewrites member variants, which are out of the range of the function. That is why the system raised an access violation exception.</p>

  </div>
</article>



    </div>
    
      <div id="footer-post-container">
  <div id="footer-post">

    <div id="nav-footer" style="display: none">
      <ul>
         
          <li><a href="/">Home</a></li>
         
          <li><a href="/archives/">Blog</a></li>
         
          <li><a href="/research/">Research</a></li>
         
          <li><a href="/links/">Links</a></li>
         
          <li><a href="/about/">About</a></li>
        
      </ul>
    </div>

    <div id="toc-footer" style="display: none">
      <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#The-ctypes-package"><span class="toc-number">1.</span> <span class="toc-text">The ctypes package</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#A-Simple-Example"><span class="toc-number">2.</span> <span class="toc-text">A Simple Example</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#A-Failed-C-Class-Example"><span class="toc-number">3.</span> <span class="toc-text">A Failed C++ Class Example</span></a></li></ol>
    </div>

    <div id="share-footer" style="display: none">
      <ul>
  <li><a class="icon" href="http://www.facebook.com/sharer.php?u=http://www.quxiaofeng.me/2014/02/28/ctypes-example/"><i class="fab fa-facebook fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://twitter.com/share?url=http://www.quxiaofeng.me/2014/02/28/ctypes-example/&text=A Little ctypes Example"><i class="fab fa-twitter fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.linkedin.com/shareArticle?url=http://www.quxiaofeng.me/2014/02/28/ctypes-example/&title=A Little ctypes Example"><i class="fab fa-linkedin fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://pinterest.com/pin/create/bookmarklet/?url=http://www.quxiaofeng.me/2014/02/28/ctypes-example/&is_video=false&description=A Little ctypes Example"><i class="fab fa-pinterest fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=A Little ctypes Example&body=Check out this article: http://www.quxiaofeng.me/2014/02/28/ctypes-example/"><i class="fas fa-envelope fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://getpocket.com/save?url=http://www.quxiaofeng.me/2014/02/28/ctypes-example/&title=A Little ctypes Example"><i class="fab fa-get-pocket fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://reddit.com/submit?url=http://www.quxiaofeng.me/2014/02/28/ctypes-example/&title=A Little ctypes Example"><i class="fab fa-reddit fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.stumbleupon.com/submit?url=http://www.quxiaofeng.me/2014/02/28/ctypes-example/&title=A Little ctypes Example"><i class="fab fa-stumbleupon fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://digg.com/submit?url=http://www.quxiaofeng.me/2014/02/28/ctypes-example/&title=A Little ctypes Example"><i class="fab fa-digg fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.tumblr.com/share/link?url=http://www.quxiaofeng.me/2014/02/28/ctypes-example/&name=A Little ctypes Example&description=&lt;p&gt;A simple ctypes example interfacing a windows dll to python.&lt;/p&gt;"><i class="fab fa-tumblr fa-lg" aria-hidden="true"></i></a></li>
</ul>

    </div>

    <div id="actions-footer">
        <a id="menu" class="icon" href="#" onclick="$('#nav-footer').toggle();return false;"><i class="fas fa-bars fa-lg" aria-hidden="true"></i> Menu</a>
        <a id="toc" class="icon" href="#" onclick="$('#toc-footer').toggle();return false;"><i class="fas fa-list fa-lg" aria-hidden="true"></i> TOC</a>
        <a id="share" class="icon" href="#" onclick="$('#share-footer').toggle();return false;"><i class="fas fa-share-alt fa-lg" aria-hidden="true"></i> Share</a>
        <a id="top" style="display:none" class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fas fa-chevron-up fa-lg" aria-hidden="true"></i> Top</a>
    </div>

  </div>
</div>

    
    <footer id="footer">
  <div class="footer-left">
    Copyright &copy; 2018 Xiaofeng QU
  </div>
  <div class="footer-right">
    <nav>
      <ul>
         
          <li><a href="/">Home</a></li>
         
          <li><a href="/archives/">Blog</a></li>
         
          <li><a href="/research/">Research</a></li>
         
          <li><a href="/links/">Links</a></li>
         
          <li><a href="/about/">About</a></li>
        
      </ul>
    </nav>
  </div>
</footer>

</body>
</html>
<!-- styles -->
<link rel="stylesheet" href="/lib/font-awesome/css/fontawesome-all.min.css">
<link rel="stylesheet" href="/lib/justified-gallery/css/justifiedGallery.min.css">

<!-- jquery -->
<script src="/lib/jquery/jquery.min.js"></script>
<script src="/lib/justified-gallery/js/jquery.justifiedGallery.min.js"></script>
<script src="/js/main.js"></script>
<!-- search -->

<!-- Google Analytics -->

<!-- Baidu Analytics -->

<!-- Disqus Comments -->


