<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <title>A Little ctypes Example | Xiaofeng QU</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="A simple ctypes example interfacing a windows dll to python.">
<meta name="keywords" content="python,c++,note,c">
<meta property="og:type" content="article">
<meta property="og:title" content="A Little ctypes Example">
<meta property="og:url" content="http://www.quxiaofeng.me/2014/02/28/ctypes-example/index.html">
<meta property="og:site_name" content="Xiaofeng QU">
<meta property="og:description" content="A simple ctypes example interfacing a windows dll to python.">
<meta property="og:locale" content="en-US">
<meta property="og:image" content="http://i.imgur.com/EsDsYsI.png">
<meta property="og:updated_time" content="2018-04-19T04:35:09.401Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="A Little ctypes Example">
<meta name="twitter:description" content="A simple ctypes example interfacing a windows dll to python.">
<meta name="twitter:image" content="http://i.imgur.com/EsDsYsI.png">
<meta name="twitter:creator" content="@http:&#x2F;&#x2F;twitter.com&#x2F;quxiaofeng">
  
  
    <link rel="icon" href="images/favicon.png">
  
  <link href='//fonts.googleapis.com/css?family=Open+Sans:400italic,400,600' rel='stylesheet' type='text/css'>
  <link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  <link rel="stylesheet" href="/css/style.css">
  <link rel="stylesheet" href="/font-awesome/css/font-awesome.min.css">
  
<!-- Google Analytics -->
<script type="text/javascript">
(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','//www.google-analytics.com/analytics.js','ga');

ga('create', 'UA-50831338-1', 'auto');
ga('send', 'pageview');

</script>
<!-- End Google Analytics -->


  
</head>

<body>
  <div id="container">
    <header id="header">
  <div id="header-main" class="header-inner">
    <div class="outer">
      <a href="/." id="logo"><i class="logo"></i><span class="site-title">Xiaofeng QU</span></a>
      <nav id="main-nav">
        
          <a class="main-nav-link" href="/.">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
          <a class="main-nav-link" href="/research">Research</a>
        
          <a class="main-nav-link" href="/links">Links</a>
        
          <a class="main-nav-link" href="/about">About</a>
        
      </nav>
      
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit"> </button><input type="hidden" name="sitesearch" value="http://www.quxiaofeng.me"></form>
      </div>
    </div>
  </div>
  <div id="main-nav-mobile" class="header-sub header-inner">
    <table class="menu outer">
      <tr>
      
        <td><a class="main-nav-link" href="/.">Home</a></td>
      
        <td><a class="main-nav-link" href="/archives">Archives</a></td>
      
        <td><a class="main-nav-link" href="/research">Research</a></td>
      
        <td><a class="main-nav-link" href="/links">Links</a></td>
      
        <td><a class="main-nav-link" href="/about">About</a></td>
      
      <td>
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><input type="hidden" name="sitesearch" value="http://www.quxiaofeng.me"></form>
      </td>
      </tr>
    </table>
  </div>
</header>

    <div class="outer">
      
      <section id="main"><article id="post-ctypes-example" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-inner">
    
    
<div class="article-gallery">
  <div class="article-gallery-photos">
    
      <a class="article-gallery-img fancybox" href="http://i.imgur.com/EsDsYsI.png" rel="gallery_cjg6198x40033h42eifjq2c31">
        <img src="http://i.imgur.com/EsDsYsI.png" itemprop="image">
      </a>
    
  </div>
</div>

    
      <header class="article-header">
        
  
    <h1 class="article-title" itemprop="name">
      A Little ctypes Example
    </h1>
  

        <div class="article-meta">
          
  <div class="article-date">
    <i class="fa fa-calendar"></i>
    <a href="/2014/02/28/ctypes-example/">
      <time datetime="2014-02-28T19:27:07.000Z" itemprop="datePublished">February 28, 2014</time>
    </a>
  </div>


          
  <div class="article-category">
  	<i class="fa fa-folder"></i>
    <a class="article-category-link" href="/categories/coding/">coding</a>
  </div>

        </div>
      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>A simple ctypes example interfacing a windows dll to python.</p>
<a id="more"></a>
<h2 id="The-ctypes-package"><a href="#The-ctypes-package" class="headerlink" title="The ctypes package"></a>The ctypes package</h2><ul>
<li><a href="http://starship.python.net/crew/theller/ctypes/" target="_blank" rel="noopener">Homepage</a></li>
</ul>
<p>“ctypes” is an advanced ffi (Foreign Function Interface) , and it has been included in the standard distribution of python since 2.5.</p>
<p>“ctypes allows to call functions in dlls/shared libraries and has extensive facilities to create, access and manipulate simple and complicated C data types in Python - in other words: wrap libraries in pure Python. It is even possible to implement C callback functions in pure Python.”</p>
<p>In essence, ctypes find the name of C functions in the dll file and execute the function code directly. It provides a very easy and effective way to call C functions from python. A simple example is shown below.</p>
<h2 id="A-Simple-Example"><a href="#A-Simple-Example" class="headerlink" title="A Simple Example"></a>A Simple Example</h2><pre><code>from ctypes import *
user32 = windll.LoadLibrary(&apos;user32.dll&apos;) # load dll
user32.MessageBoxA(0, &apos;Ctypes is cool!&apos;, &apos;Ctypes&apos;, 0)
# call message box function
</code></pre><p>First, the ctypes package is imported to current file. Then the user32.dll is loaded as variant user32. (user32.dll is a basic windows dynamic library. It is pre-installed in every windows operating system.) After the loading of user32 library, we can call MessageBoxA function, which is in the user32 library as an ordinary python method. The MessageBoxA pops up a message box over the desktop. The parameters defined the text and title of this message box as shown below.</p>
<figure><br>  <img src="http://i.imgur.com/EsDsYsI.png"><br>  <figcaption><br>  Message box called by python<br>  </figcaption><br></figure>

<p>In this calling process, no lower level code is need. DLL functions can be called solely by python.</p>
<p>However, a critical problem is that the ctypes package only supports C function or C++ function without Class feature. <strong>It does not support C++ Class.</strong></p>
<h2 id="A-Failed-C-Class-Example"><a href="#A-Failed-C-Class-Example" class="headerlink" title="A Failed C++ Class Example"></a>A Failed C++ Class Example</h2><p>The C function name saving in the dll file is identical with one in the source file. Nevertheless, the C++ function is not. For example, a function name is “enum ePiCommType CPDIdev::DiscoverCnx(int)” in source file. In the DLL file, the function name is “?DiscoverCnx@CPDIdev@@UAE?AW4ePiCommType@@H@Z” as shown in the figure below. The ctypes package can resolve latter one as the former one. That is how it can call C functions.</p>
<figure><br>  <img src="http://i.imgur.com/O6Gc5oz.png"><br>  <figcaption><br>  The C++ function name in the DLL file under the inspection tool<br>  </figcaption><br></figure>

<p>The names of functions can be inspected by “<a href="http://www.dependencywalker.com/" target="_blank" rel="noopener">Dependency Walker</a>“.</p>
<figure><br>  <img src="http://i.imgur.com/3I3AWXk.png"><br>  <figcaption><br>  Dependency Walker Homepage<br>  </figcaption><br></figure>

<p>In addition, the python can find the function with the help of the ctypes package in a similar way as shown below.</p>
<figure><br>  <img src="http://i.imgur.com/d0Ku9wE.png"><br>  <figcaption><br>  Python find a function pointer in the DLL file<br>  </figcaption><br></figure>

<p>The address of the function “enum ePiCommType CPDIdev::DiscoverCnx(int)” is found in 0x01D65828. However, it raised an exception when it is being called as shown below.</p>
<figure><br>  <img src="http://i.imgur.com/WluRzwI.png"><br>  <figcaption><br>  Exception raised when called by python<br>  </figcaption><br></figure>

<p>This exception is raised because the ctypes does not support C++ class. In a C++ class, the member function rewrites member variants, which are out of the range of the function. That is why the system raised an access violation exception.</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://www.quxiaofeng.me/2014/02/28/ctypes-example/" data-id="cjg6198x40033h42eifjq2c31" class="article-share-link">Share</a>
      
        <a href="http://www.quxiaofeng.me/2014/02/28/ctypes-example/#disqus_thread" class="article-comment-link">Comments</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/c/">c</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/c/">c++</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/note/">note</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/python/">python</a></li></ul>

    </footer>
  </div>
  
    
<nav id="article-nav">
  
    <a href="/2014/03/01/swig-example/" id="article-nav-newer" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Newer</strong>
      <div class="article-nav-title">
        
          A SWIG Example
        
      </div>
    </a>
  
  
    <a href="/2014/02/27/canopy-welcome-issue/" id="article-nav-older" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Older</strong>
      <div class="article-nav-title">Enthought Canopy 1.3.0 Welcome Issue</div>
    </a>
  
</nav>

  
</article>


<section id="comments">
  <div id="disqus_thread">
    <noscript>Please enable JavaScript to view the <a href="//disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
  </div>
</section>

</section>
      
    </div>
    <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2012 - 2018 Xiaofeng QU<br>
      Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>. Theme by <a href="http://github.com/ppoffice">PPOffice</a>
    </div>
  </div>
</footer>
    

<script>
  var disqus_shortname = 'quxiaofenggithub';
  (function(){
    var dsq = document.createElement('script');
    dsq.type = 'text/javascript';
    dsq.async = true;
    dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
  })();
</script>


<script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>


  <link rel="stylesheet" href="/fancybox/jquery.fancybox.css">
  <script src="/fancybox/jquery.fancybox.pack.js"></script>


<script src="/js/script.js"></script>

  </div>
</body>
</html>